<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Authentication Callback</title>
	<link rel="icon" type="image/png" href="https://open.spotifycdn.com/cdn/images/favicon32.b64ecc03.png">
</head>

<body>
	<p>Processing authentication...</p>
	<script type="module">
		import config from './config.js';

		async function handleCallback() {
			const urlParams=new URLSearchParams(window.location.search);
			const code=urlParams.get("code");

			if(code) {
				try {
					const response=await fetch(`${config.API_URL}/auth/spotify/callback?code=${code}`);
					const result=await response.json();

					if(result.status==='success'&&result.data.access_token) {
						localStorage.setItem('access_token',result.data.access_token);
						window.location.href='/'; // Redirect to root
					} else {
						console.error("Authentication failed:",result.message);
						window.location.href='/?error=auth_failed';
					}
				} catch(error) {
					console.error("Error during authentication:",error);
					window.location.href='/?error=auth_error';
				}
			} else {
				window.location.href='/?error=no_code';
			}
		}

		// Execute immediately
		handleCallback();
	</script>
</body>

</html>